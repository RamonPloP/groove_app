{% extends "layouts/base.html" %}

{% block title %} Lista de empleados {% endblock %}

<!-- Element injected in the BODY element -->
{% block body_class %} {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
   <!-- Select2 -->
  <link rel="stylesheet" href="/static/assets/plugins/select2/css/select2.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="/static/assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="/static/assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <link rel="stylesheet" href="/static/assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
  <!-- Toastr -->
  <link rel="stylesheet" href="/static/assets/plugins/toastr/toastr.min.css">

{% endblock stylesheets %}

{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1><i class="fas fa-clipboard-list nav-icon"></i> Lista de asistencia Empleados</h1>
          </div>

        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
              <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Filtros</h3>
                  </div>
                  <!-- /.card-header -->
                  <form id="filter" method="post">
                      <div class="card-body row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="credit_value">Supervisor</label>
                                        <select name="supervisor_id" id="supervisor_id" class="form-control" style="width: 100%;" >
                                            <option selected="selected" value="-1" >Todos</option>
                                            {% for data in clients %}
                                                    <option value ="{{ data.id }}" >{{ data.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 offset-md-9">
                                    <button type="button" class="btn btn-primary float-right"  data-toggle="modal"  onclick="filter(event) " data-target="#modal-default">
                                      Buscar
                                    </button>
                                </div>
                              </div>
                      </form>        <!-- /.card-body -->
                    </div>

                <!-- /.card -->

            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Listado de empleados registrados en el sistema</h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <table id="banks_list" class="table table-bordered table-striped" style="width: 100%">
                  <thead>
                  <tr>
                       <th>Foto</th>
                    <th>Nombre</th>
                    <th>Punto</th>
                    <th>Acciones</th>
                  </tr>
                  </thead>
                  <tbody>
                  </tbody>
                  <tfoot>
                  <th>Foto</th>
                    <th>Nombre</th>
                    <th>Punto</th>
                    <th>Acciones</th>
                  </tfoot>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div>
      <!-- /.container-fluid -->
    </section>
  <!-- Modal -->
        <div class="modal fade" id="data_modal" tabindex="-1" role="dialog" aria-labelledby="data_modal"
             aria-hidden="true">
        </div>
    <!-- /.content -->
  </div>

{% endblock content %}
<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables -->
  <script src="/static/assets/plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="/static/assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="/static/assets/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="/static/assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="/static/assets/js/demo.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- Toastr -->
  <script src="/static/assets/plugins/toastr/toastr.min.js"></script>
   <!-- bs-custom-file-input -->
  <script src="/static/assets/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
  <!-- page script -->
       <!-- Select2 -->
  <script src="/static/assets/plugins/select2/js/select2.full.min.js"></script>
  <script>
    $(function () {
        $('#supervisor_id').select2({
            placeholder: 'Selecciona una opción',
            allowClear: true
        })

        $('#client_id').select2({
            placeholder: 'Selecciona una opción',
            allowClear: true
        })
$('form[name="search"]').submit(function(evt) {
          evt.preventDefault();
          $.each($(this).serializeArray(), function(index, value) {
            data[value.name] = value.value;
          });
          table.ajax.reload();
        });
    // Obtener los elementos del HTML
var client = $("#client_id");
// Agregar un evento de cambio al primer input para actualizar el segundo input
client.on("change", function() {
    document.getElementById("clients_trade_name_id").innerHTML=""
     var opcion = document.createElement("option");
    opcion.value = "-1";
    opcion.text = "Todos";
    document.getElementById("clients_trade_name_id").appendChild(opcion);
    var client_id = client.val();
    get_json_trade_neme(client_id)

});



    });


function show_add_attendance(id,modal_type,button) {
        {#$(button).attr('disabled', true);#}
        axios({
            method: 'get',
            url: '/admin/attendance/show/',
            params: {
                employee_id: id,
                modal_type:modal_type
              }
        }).then(function (response) {
            $('#data_modal').html(response.data)
            $('#data_modal').modal("show")
        }).catch(function (error) {
            console.log(error)
        }).finally(function () {
        });
     }
function show_info_end(id,button) {
        {#$(button).attr('disabled', true);#}
        axios({
            method: 'get',
            url: '/admin/info-end/show/',
            params: {
                employee_id: id
              }
        }).then(function (response) {
            $('#data_modal').html(response.data)
            $('#data_modal').modal("show")
        }).catch(function (error) {
            console.log(error)
        }).finally(function () {
        });
     }
function show_add_credit(id,button) {
        {#$(button).attr('disabled', true);#}
        axios({
            method: 'get',
            url: '/admin/employee/credit/',
            params: {
                employee_id: id
              }
        }).then(function (response) {
            $('#data_modal').html(response.data)
            $('#data_modal').modal("show")
        }).catch(function (error) {
            console.log(error)
        }).finally(function () {
        });
     }

    function filter(e) {
        e.preventDefault()
        var client_id = $('#supervisor_id').val()
        console.log(client_id)
        var clients_trade_name_id = 0
        update_table(client_id,clients_trade_name_id)
    }


    function update_table(client_id,clients_trade_name_id) {
             let data = {};
             $('#banks_list').DataTable().clear();
             $('#banks_list').DataTable().destroy();
             $('#banks_list').DataTable({
                        dom: 'lBfrtip',
                        buttons: [
                             'csv', 'excel',
                        ],
                        order: {
                            name: 'PUNTO',
                            dir: 'asc'
                        },
                        language: {
                            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json',
                        },
                 responsive: true,
                 columnDefs: [
                     { responsivePriority: 1, targets: 1 },
                     { responsivePriority: 2, targets: 3 },
                     { responsivePriority: 10000, targets: 0 },
                     { responsivePriority: 100000, targets: 2 },
                     {
                        "defaultContent": "-",
                        "targets": "_all"
                      }
                    ],
                        processing: true,
                        serverSide: true,
                          searching: true,
                          ordering: false,
                          pagingType: 'full_numbers',
                          pageLength: 100,
                          ajax: {
                            url: {{ url_for('admin.employees_list_filter') | tojson }},
                            dataSrc: 'data',
                            data: function (d) {
                              d = $.extend(d, data);
                              d.client_id=client_id
                              d.clients_trade_name_id = clients_trade_name_id
                            }
                          },
                        columns: [
                            {title: "FOTO",render: function (data, type, row) {
                              return '<img style="width: 100%;" src="'+row.photo+'">'
                            }},
                            {title: "NOMBRE",render: function (data, type, row) {
                              return row.name
                            }},{title: "PUNTO",render: function (data, type, row) {
                              return row.client
                            }},
                            {title: "ACCIONES",render: function (data, type, row) {
                                if(row.status=='2'){
                                    return '<span class="text-warning">INCAPACITADO  </span>'+
                                        '<button type="button" class="btn btn-sm btn-outline-info button_'+row.id+'" onclick="show_info_end('+row.id  +' ,this)" title="informar sobre empleado">'+
                                            '<i class="fas fa-info-circle"></i>'+
                                        '</button>'
                                }
                                return ' <button type="button" class="btn btn-sm btn-outline-success button_'+row.id+'" onclick="show_add_attendance('+row.id +','+ '\'attendance\'' +',this)" title="asistencia">'+
                                        '<i class="fas fa-check"></i>'+
                                    '</button>'+
                                    ' <button type="button" class="btn btn-sm btn-outline-danger button_'+row.id+'" onclick="show_add_attendance('+row.id +','+ '\'absence\'' +',this)" title="Falta">'+
                                        '<i class="fas fa-times"></i>'+
                                    '</button>'+
                                    '<button type="button" class="btn btn-sm btn-outline-warning" onclick="show_add_attendance('+row.id +','+ '\'extra_time\'' +',this)" title="Tiempo extra">'+
                                        '<i class="fas fa-clock"></i>'+
                                    '</button>'+
                                    '<button type="button" class="btn btn-sm btn-outline-info button_'+row.id+'" onclick="show_info_end('+row.id  +' ,this)" title="informar baja">'+
                                        '<i class="fas fa-info-circle"></i>'+
                                    '</button>'


                            }
                            }
                        ]
                    });

    }

    function get_employees() {
         update_table()
    }

function register(e,url) {
        e.preventDefault()
        var form = $("#addForm")[0]
        if (!form.checkValidity())
            form.reportValidity()
        else {
           var employee_id=$("#employee_id").val()
            axios({
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                url: url,
                data: new FormData(form)
            }).then(function (response) {
                toastr.success(response.data, { timeOut: 9500 })
                $('#data_modal').modal("hide")
            }).catch(function (error) {
                toastr.error(error.response.data)
                console.log(error)
            }).finally(function () {

            });
        }

    }



function register_credit(e) {
        e.preventDefault()
        var form = $("#addForm")[0]
        if (!form.checkValidity())
            form.reportValidity()
        else {
            employee_id=$("#employee_id").value()
            axios({
                method: 'post',
                headers: {
                    'Content-Type': 'application/json'
                },
                url: '/admin/employee/credit/add',
                data: new FormData(form)
            }).then(function (response) {
                toastr.success(response.data, { timeOut: 9500 })
                 update_table()
                $('#data_modal').modal("hide")
            }).catch(function (error) {
                toastr.error(error.response.data)
                console.log(error)
            }).finally(function () {

            });
        }
    }

    document.getElementById('client_id').addEventListener('change', function() {
    var clientId = this.value;
    var tradeNameSelect = $('#clients_trade_name_id');

        $.ajax({
            url: '/admin/clientsradenames/?id=' + clientId,
            type: 'GET',
            success: function(response) {
                tradeNameSelect.empty();
                $.each(response, function(index, option) {
                    var newOption = new Option(option.trade_name, option.trade_id, true, true);
                    tradeNameSelect.append(newOption).trigger('change');
                });
            },
            error: function(xhr, status, error) {
                console.error('Error en la solicitud AJAX:', status);
            }
        });
    });

  </script>

{% endblock javascripts %}

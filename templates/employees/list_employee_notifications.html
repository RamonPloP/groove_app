{% extends "layouts/base.html" %}

{% block title %} Lista de notificaciones de cambios {% endblock %}

<!-- Element injected in the BODY element -->
{% block body_class %} {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="/static/assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="/static/assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <link rel="stylesheet" href="/static/assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
  <!-- Toastr -->
  <link rel="stylesheet" href="/static/assets/plugins/toastr/toastr.min.css">
<style>
        td.dt-control {
            cursor: pointer;
        }
    </style>
{% endblock stylesheets %}

{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1><i class="fas  fa-user nav-icon"></i>Cambios de Empleados</h1>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Listado de cambios registrados en el sistema</h3>
          </div>
          <div class="card-body">
            <table id="datatable_list" class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th></th>
                  <th>Empleado</th>
                  <th>Sueldo Nuevo</th>
                  <th>Cliente Nuevo</th>
                  <th>Estatus</th>
                  <th>Fecha de cambio</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
              <tfoot>
                <tr>
                  <th></th>
                  <th>Empleado</th>
                  <th>Sueldo Nuevo</th>
                  <th>Sueldo Viejo</th>
                  <th>Cliente Nuevo</th>
                  <th>Cliente Viejo</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


  <!-- Modal -->
        <div class="modal fade" id="data_modal" tabindex="-1" role="dialog" aria-labelledby="data_modal"
             aria-hidden="true">
        </div>
    <!-- /.content -->
  </div>

{% endblock content %}
<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables -->
  <script src="/static/assets/plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="/static/assets/plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="/static/assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="/static/assets/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="/static/assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="/static/assets/js/demo.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- Toastr -->
  <script src="/static/assets/plugins/toastr/toastr.min.js"></script>
   <!-- bs-custom-file-input -->
  <script src="/static/assets/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
  <!-- page script -->
    <script src="http://momentjs.com/downloads/moment.min.js"></script>

    <script>
// Formato para detalles adicionales en las filas
function format(d) {
    return (
        '<dl>' +
        '<dt>Empleado:</dt>' +
        '<dd>' + d[1] + '</dd>' +
        '<dt>Sueldo Nuevo:</dt>' +
        '<dd>' + d[2] + '</dd>' +
        '<dt>Sueldo Anterior:</dt>' +
        '<dd>' + d[3] + '</dd>' +
        '<dt>Cliente Nuevo:</dt>' +
        '<dd>' + d[4] + '</dd>' +
        '<dt>Cliente Anterior:</dt>' +
        '<dd>' + d[5] + '</dd>' +
        '<dt>Registro Patronal Nuevo:</dt>' +
        '<dd>' + d[6] + '</dd>' +
        '<dt>Registro Patronal Anterior:</dt>' +
        '<dd>' + d[7] + '</dd>' +
        '<dt>Creado por:</dt>' +
        '<dd>' + d[8] + '</dd>' +
        '<dt>Status:</dt>' +
        '<dd>' + d[9] + '</dd>' +
        '<dt>Fecha de cambio:</dt>' +
        '<dd>' + d[10] + '</dd>' +
        '<dt>Fecha de creación:</dt>' +
        '<dd>' + d[11] + '</dd>' +
        '</dl>'
    );
}

$(function() {
    get_data('/employees/get_changes/');
});

function get_data(url) {
    $.getJSON(url, function (data) {
        update_table(data);
    });
}

function update_table(data) {
    let changes = [];
    $.each(data, function (i, element) {
        let change = [];
        change.push(''); // Placeholder for the control column
        change.push(element.employee_name);
        change.push(element.salary_new);
        change.push(element.salary_old);
        change.push(element.new_trade_name);
        change.push(element.old_trade_name);
        change.push(element.new_employer);
        change.push(element.old_employer);
        change.push(element.created_by);
        change.push(element.status);

        let date = new Date(element.change_date);
        let day = String(date.getDate()).padStart(2, '0');
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let year = date.getFullYear();
        let formattedDate = `${day}/${month}/${year}`;
        change.push(formattedDate);

        date = new Date(element.created_date);
        day = String(date.getDate()).padStart(2, '0');
        month = String(date.getMonth() + 1).padStart(2, '0');
        year = date.getFullYear();
        formattedDate = `${day}/${month}/${year}`;
        change.push(formattedDate);

        changes.push(change);
    });

    $('#datatable_list').DataTable().clear();
    $('#datatable_list').DataTable().destroy();
    let table = $('#datatable_list').DataTable({
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json',
        },
        data: changes,
        columns: [
            {
                className: 'dt-control',
                orderable: false,
                data: null,
                defaultContent: '<i class="fas fa-plus-minus"></i>'
            },
            {title: "Empleado"},
            {title: "Sueldo Nuevo"},
            {title: "Sueldo Anterior"},
            {title: "Cliente Nuevo"},
            {title: "Cliente Viejo"}
        ],
        order: [[1, 'asc']]
    });

    // Añadir evento para abrir y cerrar detalles
    $('#datatable_list tbody').on('click', 'td.dt-control', function () {
        let tr = $(this).closest('tr');
        let row = table.row(tr);

        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
        } else {
            row.child(format(row.data())).show();
            tr.addClass('shown');
        }
    });
}

    </script>

{% endblock javascripts %}


